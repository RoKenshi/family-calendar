<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–°–µ–º–µ–π–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body class="bg-gray-900 text-white">

  <div class="flex items-center justify-center py-8 px-4">
            <div class="max-w-sm w-full shadow-lg">
                <div class="md:p-8 p-5 dark:bg-gray-800 bg-white rounded-t">
                    <div class="px-4 flex items-center justify-between">
          <div>
            <span id="calendar-title" tabindex="0" class="focus:outline-none text-base font-bold dark:text-gray-100 text-gray-800">January 2025</span>
            <div id="user-info" class="hidden text-xs text-gray-400 dark:text-gray-400 mt-1">
              <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å -->
            </div>
          </div>
                        <div class="flex items-center">
            <button id="prev-month" aria-label="calendar backward" class="focus:text-gray-400 hover:text-gray-400 text-gray-800 dark:text-gray-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                <polyline points="15 6 9 12 15 18" />
                            </svg>
                        </button>
            <button id="next-month" aria-label="calendar forward" class="focus:text-gray-400 hover:text-gray-400 ml-3 text-gray-800 dark:text-gray-100"> 
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                                <polyline points="9 6 15 12 9 18" />
                            </svg>
                        </button>
                        </div>
                    </div>
                    <div class="flex items-center justify-between pt-12 overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr>
                <th><div class="w-full flex justify-center"><p class="text-base font-medium text-center text-gray-800 dark:text-gray-100">Mo</p></div></th>
                <th><div class="w-full flex justify-center"><p class="text-base font-medium text-center text-gray-800 dark:text-gray-100">Tu</p></div></th>
                <th><div class="w-full flex justify-center"><p class="text-base font-medium text-center text-gray-800 dark:text-gray-100">We</p></div></th>
                <th><div class="w-full flex justify-center"><p class="text-base font-medium text-center text-gray-800 dark:text-gray-100">Th</p></div></th>
                <th><div class="w-full flex justify-center"><p class="text-base font-medium text-center text-gray-800 dark:text-gray-100">Fr</p></div></th>
                <th><div class="w-full flex justify-center"><p class="text-base font-medium text-center text-gray-800 dark:text-gray-100">Sa</p></div></th>
                <th><div class="w-full flex justify-center"><p class="text-base font-medium text-center text-gray-800 dark:text-gray-100">Su</p></div></th>
                                </tr>
                            </thead>
            <tbody id="calendar-body">
              <!-- Calendar days will be generated by JavaScript -->
            </tbody>
          </table>
                                        </div>
                                        </div>
      <div class="md:py-8 py-5 md:px-16 px-5 dark:bg-gray-700 bg-gray-50 rounded-b">
        <div class="px-4" id="events-list">
          <p class="text-sm text-gray-500 dark:text-gray-300">–°–æ–±—ã—Ç–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è</p>
                                        </div>
                                        </div>
                                        </div>
                                        </div>

  <!-- Modal –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è -->
  <div id="event-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-opacity">
    <div class="bg-gray-800 dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 transform transition-all">
      <div class="px-6 py-4 border-b border-gray-700">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-semibold text-white dark:text-white">–ù–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ</h3>
          <button id="close-modal" class="text-gray-400 hover:text-gray-200 transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
                                            </div>
                                        </div>
      <div class="px-6 py-4">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-300 mb-2" for="event-date">
            –î–∞—Ç–∞
          </label>
          <input 
            type="text" 
            id="event-date" 
            readonly
            class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-indigo-500"
          />
                                        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-300 mb-2" for="event-time">
            –í—Ä–µ–º—è
          </label>
          <input 
            type="time" 
            id="event-time" 
            class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            value="09:00"
          />
                                        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-300 mb-2" for="event-title">
            –ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
          </label>
          <input 
            type="text" 
            id="event-title" 
            placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è"
            class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            autofocus
          />
                                        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-300 mb-2" for="event-duration">
            –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω—É—Ç—ã)
          </label>
          <input 
            type="number" 
            id="event-duration" 
            min="15"
            step="15"
            class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            value="60"
            placeholder="60"
          />
                                        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-300 mb-2" for="event-description">
            –û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
          </label>
          <textarea 
            id="event-description" 
            rows="3"
            placeholder="–î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è"
            class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none"
          ></textarea>
                                        </div>
                                        </div>
      <div class="px-6 py-4 border-t border-gray-700 flex justify-end space-x-3">
        <button 
          id="cancel-btn" 
          class="px-4 py-2 text-gray-300 hover:text-white bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500"
        >
          –û—Ç–º–µ–Ω–∞
        </button>
        <button 
          id="save-btn" 
          class="px-4 py-2 text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-800"
        >
          –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
        </button>
                                        </div>
                    </div>
                </div>

  <!-- Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
  <div id="toast" class="hidden fixed top-4 right-4 bg-gray-800 border border-gray-700 rounded-lg shadow-lg px-6 py-4 z-50 transform transition-all">
    <div class="flex items-center space-x-3">
      <div id="toast-icon"></div>
      <p id="toast-message" class="text-white"></p>
                        </div>
                        </div>

  <script>
    // API endpoint –¥–ª—è Spring Boot Backend
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ URL –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    function getApiBaseUrl() {
      // –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä URL –¥–ª—è –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
      const urlParams = new URLSearchParams(window.location.search);
      const apiUrl = urlParams.get('api_url');
      if (apiUrl) {
        return apiUrl;
      }
      
      // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –ª–æ–∫–∞–ª—å–Ω–æ (–Ω–µ —á–µ—Ä–µ–∑ Telegram –∏–ª–∏ localhost)
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        return 'http://localhost:8080';
      }
      
      // –ü—Ä–æ–¥–∞–∫—à–µ–Ω: –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å /family-calendar/api
      // Nginx –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç /family-calendar/api -> localhost:8080
      return window.location.origin + '/family-calendar';
    }
    
    const API_BASE_URL = getApiBaseUrl();
    console.log('üîß API Base URL:', API_BASE_URL);
    console.log('üîß Current location:', window.location.href);
    console.log('üîß Origin:', window.location.origin);
    
    // –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    const DEBUG = true; // –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    
    function logDebug(category, message, data = null) {
      if (DEBUG) {
        const timestamp = new Date().toISOString();
        const prefix = `[${timestamp}] [${category}]`;
        console.log(prefix, message, data || '');
      }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    const tg = window.Telegram?.WebApp;
    let currentUser = null;
    let telegramInitData = null; // –ü–æ–ª–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ initData –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞

    logDebug('INIT', 'Telegram WebApp SDK:', {
      available: !!tg,
      version: tg?.version,
      platform: tg?.platform,
      initDataUnsafe: tg?.initDataUnsafe ? 'present' : 'missing',
      initData: tg?.initData ? 'present' : 'missing'
    });

    // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –æ—Ç–∫—Ä—ã—Ç–æ —á–µ—Ä–µ–∑ Telegram
    if (!tg?.initDataUnsafe?.user) {
      logDebug('AUTH', '‚ùå Telegram user not found', {
        tgAvailable: !!tg,
        initDataUnsafe: !!tg?.initDataUnsafe,
        user: !!tg?.initDataUnsafe?.user
      });
      alert("–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram");
    } else {
      tg.ready();
      tg.expand(); // –†–∞—Å–∫—Ä—ã–≤–∞–µ–º WebApp –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
      
      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const user = tg.initDataUnsafe.user;
      currentUser = {
        id: user.id,
        name: user.first_name,
        username: user.username || null,
      };
      
      logDebug('AUTH', '‚úÖ Telegram user found', {
        id: currentUser.id,
        name: currentUser.name,
        username: currentUser.username
      });
      
      // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—É—é —Å—Ç—Ä–æ–∫—É initData –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ X-Telegram-Init-Data
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–µ–Ω–Ω–æ tg.initData (–∫–∞–∫ —É–∫–∞–∑–∞–Ω–æ –≤ FRONTEND_GUIDE.md)
      telegramInitData = tg.initData;
      
      if (!telegramInitData) {
        logDebug('AUTH', '‚ö†Ô∏è Telegram initData –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', {
          tgInitData: !!tg.initData,
          tgInitDataRaw: tg.initData ? tg.initData.substring(0, 50) + '...' : 'null'
        });
        console.warn('Telegram initData –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ —á–µ—Ä–µ–∑ Telegram WebApp.');
      } else {
        logDebug('AUTH', '‚úÖ Telegram initData –ø–æ–ª—É—á–µ–Ω', {
          length: telegramInitData.length,
          preview: telegramInitData.substring(0, 100) + '...',
          hasUser: telegramInitData.includes('user='),
          hasHash: telegramInitData.includes('hash=')
        });
      }
      
      console.log('üë§ Telegram user:', currentUser);
      console.log('üîë InitData available:', !!telegramInitData);
      if (telegramInitData) {
        console.log('üîë InitData preview:', telegramInitData.substring(0, 150) + '...');
      }
    }

    // –¢–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å (–ø–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º ID 1 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
    // –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—ã–±–æ—Ä –∫–∞–ª–µ–Ω–¥–∞—Ä—è —á–µ—Ä–µ–∑ UI
    let currentCalendarId = 1;

    let currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let selectedDate = null;

    const monthNamesRu = [
      '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
      '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
    ];

    function formatDate(year, month, day) {
      const m = String(month + 1).padStart(2, '0');
      const d = String(day).padStart(2, '0');
      return `${year}-${m}-${d}`;
    }

    function formatDateDisplay(dateStr) {
      const [year, month, day] = dateStr.split('-');
      const date = new Date(year, month - 1, day);
      const dayNames = ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞'];
      const monthNames = ['—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è', 
                         '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'];
      return `${dayNames[date.getDay()]}, ${day} ${monthNames[date.getMonth()]} ${year}`;
    }

    function formatTime(time24) {
      // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è 24—á —Ñ–æ—Ä–º–∞—Ç–∞ –≤ 12—á —Ñ–æ—Ä–º–∞—Ç (9:00 AM)
      const [hours, minutes] = time24.split(':');
      const h = parseInt(hours);
      const ampm = h >= 12 ? 'PM' : 'AM';
      const h12 = h % 12 || 12;
      return `${h12}:${minutes} ${ampm}`;
    }

    function showModal(date) {
      selectedDate = date;
      const modal = document.getElementById('event-modal');
      const dateInput = document.getElementById('event-date');
      const timeInput = document.getElementById('event-time');
      const titleInput = document.getElementById('event-title');
      const durationInput = document.getElementById('event-duration');
      const descriptionInput = document.getElementById('event-description');
      
      dateInput.value = formatDateDisplay(date);
      timeInput.value = '09:00';
      titleInput.value = '';
      durationInput.value = '60';
      descriptionInput.value = '';
      modal.classList.remove('hidden');
      
      // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
      setTimeout(() => titleInput.focus(), 100);
    }

    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç date (YYYY-MM-DD) –∏ time (HH:MM) –≤ ISO-8601 —Ñ–æ—Ä–º–∞—Ç (UTC)
    // –°–æ–∑–¥–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—É—é –¥–∞—Ç—É/–≤—Ä–µ–º—è –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤ UTC —Å–æ–≥–ª–∞—Å–Ω–æ FRONTEND_GUIDE.md
    function combineDateTime(dateStr, timeStr) {
      // dateStr: "2025-01-08"
      // timeStr: "09:00" (–ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –∏–∑ input[type="time"])
      // –†–µ–∑—É–ª—å—Ç–∞—Ç: "2025-01-08T09:00:00Z" (UTC)
      
      // –°–æ–∑–¥–∞–µ–º Date –æ–±—ä–µ–∫—Ç —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º
      const [year, month, day] = dateStr.split('-').map(Number);
      const [hours, minutes] = timeStr.split(':').map(Number);
      const localDate = new Date(year, month - 1, day, hours, minutes);
      
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º ISO —Å—Ç—Ä–æ–∫—É (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤ UTC)
      return localDate.toISOString();
    }

    function hideModal() {
      const modal = document.getElementById('event-modal');
      modal.classList.add('hidden');
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏—è –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏
      if (selectedDate) {
        renderEvents();
      }
      // –ù–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º lastClickedDate, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —Å–Ω–æ–≤–∞ –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –ø–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É –∫–ª–∏–∫—É
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');
      const toastIcon = document.getElementById('toast-icon');
      
      toastMessage.textContent = message;
      
      if (type === 'success') {
        toastIcon.innerHTML = `
          <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        `;
      } else {
        toastIcon.innerHTML = `
          <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        `;
      }
      
      toast.classList.remove('hidden');
      setTimeout(() => {
        toast.classList.add('hidden');
      }, 3000);
    }

    function renderCalendar() {
      const titleElement = document.getElementById('calendar-title');
      titleElement.textContent = `${monthNamesRu[currentMonth]} ${currentYear}`;

      const calendarBody = document.getElementById('calendar-body');
      calendarBody.innerHTML = '';

      const firstDay = new Date(currentYear, currentMonth, 1);
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; // –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ = 0

      let date = 1;
      const weeksNeeded = Math.ceil((startingDayOfWeek + daysInMonth) / 7);

      for (let week = 0; week < weeksNeeded; week++) {
        const row = document.createElement('tr');
        
        for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
          const cell = document.createElement('td');
          if (week === 0 && dayOfWeek < startingDayOfWeek) {
            // –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º –¥–Ω–µ–º –º–µ—Å—è—Ü–∞
            cell.className = 'pt-6';
            const div = document.createElement('div');
            div.className = 'px-2 py-2 cursor-pointer flex w-full justify-center';
            cell.appendChild(div);
          } else if (date > daysInMonth) {
            // –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–Ω—è –º–µ—Å—è—Ü–∞
            cell.className = week === 0 ? 'pt-6' : '';
            const div = document.createElement('div');
            div.className = 'px-2 py-2 cursor-pointer flex w-full justify-center';
            cell.appendChild(div);
          } else {
            // –Ø—á–µ–π–∫–∞ —Å –¥–∞—Ç–æ–π
            const dayCell = document.createElement('div');
            dayCell.className = 'px-2 py-2 cursor-pointer flex w-full justify-center day-cell hover:bg-gray-700 rounded-lg transition-colors';
            dayCell.setAttribute('data-date', formatDate(currentYear, currentMonth, date));
            
            const today = new Date();
            const isToday = date === today.getDate() && 
                           currentMonth === today.getMonth() && 
                           currentYear === today.getFullYear();

            if (isToday) {
              dayCell.innerHTML = `
                <div class="w-full h-full">
                  <div class="flex items-center justify-center w-full rounded-full cursor-pointer">
                    <a role="link" tabindex="0" class="focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-700 focus:bg-indigo-500 hover:bg-indigo-500 text-base w-8 h-8 flex items-center justify-center font-medium text-white bg-indigo-700 rounded-full">${date}</a>
                    </div>
                </div>
              `;
            } else {
              const p = document.createElement('p');
              p.className = 'text-base text-gray-500 dark:text-gray-100 font-medium';
              p.textContent = date;
              dayCell.appendChild(p);
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –∑–¥–µ—Å—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π
            cell.appendChild(dayCell);
            date++;
          }
          row.appendChild(cell);
        }
        calendarBody.appendChild(row);
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏—è –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
      if (!selectedDate) {
        const today = new Date();
        selectedDate = formatDate(today.getFullYear(), today.getMonth(), today.getDate());
      }
      renderEvents();
    }

    // –ü–æ–ª—É—á–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏–∑ backend API
    async function fetchEvents(calendarId, startFrom, startTo) {
      if (!telegramInitData) {
        logDebug('FETCH', '‚ùå Telegram initData –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è fetchEvents');
        console.error('Telegram initData –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
        return null;
      }

      try {
        let url = `${API_BASE_URL}/api/events/calendar/${calendarId}?page=0&size=100`;
        if (startFrom && startTo) {
          url += `&startFrom=${startFrom}&startTo=${startTo}`;
        }

        logDebug('FETCH', 'üì° –ó–∞–ø—Ä–æ—Å —Å–æ–±—ã—Ç–∏–π', {
          url: url,
          method: 'GET',
          calendarId: calendarId,
          hasInitData: !!telegramInitData,
          initDataLength: telegramInitData?.length,
          headers: {
            'X-Telegram-Init-Data': telegramInitData ? telegramInitData.substring(0, 50) + '...' : 'MISSING'
          }
        });

        console.log('üì° –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π:', {
          url: url,
          hasInitData: !!telegramInitData,
          initDataPreview: telegramInitData ? telegramInitData.substring(0, 100) + '...' : 'MISSING'
        });

        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'X-Telegram-Init-Data': telegramInitData
          }
        }).catch(networkError => {
          // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫
          logDebug('FETCH', '‚ùå Network error', {
            error: networkError.message,
            name: networkError.name,
            stack: networkError.stack
          });
          console.error('Network error –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ–±—ã—Ç–∏–π:', networkError);
          throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É: ${networkError.message}`);
        });

        logDebug('FETCH', 'üì• –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω', {
          status: response.status,
          statusText: response.statusText,
          ok: response.ok,
          headers: Object.fromEntries(response.headers.entries())
        });

        if (!response.ok) {
          const errorText = await response.text().catch(() => '');
          
          logDebug('FETCH', '‚ùå –û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞', {
            status: response.status,
            statusText: response.statusText,
            errorText: errorText.substring(0, 500),
            url: url,
            requestHeaders: {
              'X-Telegram-Init-Data': telegramInitData ? telegramInitData.substring(0, 100) + '...' : 'MISSING'
            }
          });
          
          let errorMessage = `–û—à–∏–±–∫–∞: ${response.status}`;
          
          if (response.status === 401) {
            errorMessage = '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.';
            logDebug('AUTH', '‚ùå 401 Unauthorized', {
              url: url,
              initDataPresent: !!telegramInitData,
              initDataLength: telegramInitData?.length,
              initDataPreview: telegramInitData ? telegramInitData.substring(0, 200) : 'MISSING',
              responseText: errorText,
              currentUser: currentUser
            });
            console.error('üî¥ 401 Unauthorized - –î–µ—Ç–∞–ª–∏:', {
              url: url,
              initData: telegramInitData ? telegramInitData.substring(0, 200) + '...' : 'MISSING',
              user: currentUser,
              response: errorText
            });
            if (tg) {
              tg.showAlert(errorMessage);
            }
          } else if (response.status === 403) {
            errorMessage = '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—è.';
            logDebug('AUTH', '‚ùå 403 Forbidden', {
              url: url,
              responseText: errorText
            });
            if (tg) {
              tg.showAlert(errorMessage);
            }
          } else if (response.status === 400) {
            try {
              const errorData = JSON.parse(errorText);
              errorMessage = errorData.message || '–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ.';
            } catch {
              errorMessage = '–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ.';
            }
          }
          
          showToast(errorMessage, 'error');
          return null;
        }

        const page = await response.json();
        logDebug('FETCH', '‚úÖ –°–æ–±—ã—Ç–∏—è –ø–æ–ª—É—á–µ–Ω—ã', {
          count: page.content?.length || 0,
          totalElements: page.totalElements
        });
        return page.content || [];
      } catch (error) {
        logDebug('FETCH', '‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏–π', {
          message: error.message,
          name: error.name,
          stack: error.stack,
          apiUrl: API_BASE_URL
        });
        
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π:', {
          message: error.message,
          name: error.name,
          apiUrl: API_BASE_URL,
          initData: telegramInitData ? 'present' : 'missing',
          user: currentUser
        });
        
        let userMessage = error.message;
        if (error.message.includes('Failed to fetch') || error.message.includes('load failed')) {
          userMessage = `–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ backend –∑–∞–ø—É—â–µ–Ω –Ω–∞ ${API_BASE_URL}`;
        }
        
        showToast(userMessage, 'error');
        return null;
      }
    }

    // –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏–∑ API
    async function renderEvents() {
      const eventsList = document.getElementById('events-list');
      eventsList.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-300">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π...</p>';

      // –ü–æ–ª—É—á–∞–µ–º —Å–æ–±—ã—Ç–∏—è –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã –∏–ª–∏ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã
      const today = new Date();
      const todayStr = formatDate(today.getFullYear(), today.getMonth(), today.getDate());
      const targetDate = selectedDate || todayStr;

      // –í—ã—á–∏—Å–ª—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
      const firstDay = new Date(currentYear, currentMonth, 1);
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      const startFrom = `${formatDate(currentYear, currentMonth, 1)}T00:00:00Z`;
      const startTo = `${formatDate(currentYear, currentMonth, lastDay.getDate())}T23:59:59Z`;

      const allEvents = await fetchEvents(currentCalendarId, startFrom, startTo);
      
      if (!allEvents || allEvents.length === 0) {
        eventsList.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-300">–°–æ–±—ã—Ç–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è</p>';
        return;
      }

      // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã
      const selectedEvents = allEvents.filter(event => {
        if (!event.startAt) return false;
        const eventDate = new Date(event.startAt);
        const targetDateObj = new Date(targetDate + 'T00:00:00Z');
        return eventDate.toISOString().split('T')[0] === targetDateObj.toISOString().split('T')[0];
      });

      if (selectedEvents.length === 0) {
        eventsList.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-300">–ù–∞ —ç—Ç—É –¥–∞—Ç—É —Å–æ–±—ã—Ç–∏–π –Ω–µ—Ç</p>';
        return;
      }

      // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (—É–∂–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã —Å backend)
      selectedEvents.sort((a, b) => {
        if (!a.startAt) return 1;
        if (!b.startAt) return -1;
        return new Date(a.startAt) - new Date(b.startAt);
      });

      eventsList.innerHTML = selectedEvents.map((event, index) => {
        const startDate = new Date(event.startAt);
        const timeStr = `${String(startDate.getUTCHours()).padStart(2, '0')}:${String(startDate.getUTCMinutes()).padStart(2, '0')}`;
        const timeDisplay = formatTime(timeStr);
        const description = event.description || '';
        const duration = event.durationMinutes ? `${Math.floor(event.durationMinutes / 60)}—á ${event.durationMinutes % 60}–º` : '';
        
        return `
          <div class="border-b pb-4 border-gray-400 border-dashed ${index > 0 ? 'pt-5' : ''}">
            <div class="flex items-center justify-between mb-1">
              <p class="text-xs font-light leading-3 text-gray-500 dark:text-gray-300">${timeDisplay}${duration ? ` ‚Ä¢ ${duration}` : ''}</p>
            </div>
            <a tabindex="0" class="focus:outline-none text-lg font-medium leading-5 text-gray-800 dark:text-gray-100 mt-2">${event.title}</a>
            ${description ? `<p class="text-sm pt-2 leading-4 leading-none text-gray-600 dark:text-gray-300">${description}</p>` : ''}
        </div>
        `;
      }).join('');
    }

    async function saveEvent() {
      const titleInput = document.getElementById('event-title');
      const timeInput = document.getElementById('event-time');
      const durationInput = document.getElementById('event-duration');
      const descriptionInput = document.getElementById('event-description');
      
      const title = titleInput.value.trim();
      const time = timeInput.value;
      const duration = parseInt(durationInput.value) || 60;
      const description = descriptionInput.value.trim();

      if (!title) {
        titleInput.focus();
        return;
      }

      if (!selectedDate) {
        return;
      }

      if (!telegramInitData) {
        showToast('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram', 'error');
        return;
      }

      // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
      const saveBtn = document.getElementById('save-btn');
      const originalText = saveBtn.textContent;
      saveBtn.disabled = true;
      saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

      try {
        // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π (—Å–æ–≥–ª–∞—Å–Ω–æ FRONTEND_GUIDE.md)
        if (!currentCalendarId || currentCalendarId <= 0) {
          throw new Error('calendarId –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ 0');
        }
        if (!title || title.trim().length === 0) {
          throw new Error('–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ');
        }
        if (duration <= 0) {
          throw new Error('–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0');
        }
        
        if (!telegramInitData) {
          throw new Error('Telegram initData –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.');
        }
        
        // –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –≤ ISO-8601 —Ñ–æ—Ä–º–∞—Ç
        const startAt = combineDateTime(selectedDate, time);
        
        const eventData = {
          calendarId: currentCalendarId,
          title: title,
          description: description || null,
          startAt: startAt,
          durationMinutes: duration
        };

        logDebug('SAVE', 'üíæ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏—è', {
          url: `${API_BASE_URL}/api/events`,
          method: 'POST',
          data: eventData,
          hasInitData: !!telegramInitData,
          initDataLength: telegramInitData?.length,
          initDataPreview: telegramInitData ? telegramInitData.substring(0, 100) + '...' : 'MISSING'
        });

        console.log('üíæ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏—è:', {
          url: `${API_BASE_URL}/api/events`,
          data: eventData,
          hasInitData: !!telegramInitData,
          initDataPreview: telegramInitData ? telegramInitData.substring(0, 150) + '...' : 'MISSING'
        });

        const response = await fetch(`${API_BASE_URL}/api/events`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Telegram-Init-Data': telegramInitData
          },
          body: JSON.stringify(eventData)
        }).catch(networkError => {
          // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫ (CORS, —Ç–∞–π–º–∞—É—Ç, –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω —Å–µ—Ä–≤–µ—Ä)
          logDebug('SAVE', '‚ùå Network error', {
            error: networkError.message,
            name: networkError.name
          });
          console.error('Network error:', networkError);
          throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É: ${networkError.message}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ backend –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É ${API_BASE_URL}`);
        });

        logDebug('SAVE', 'üì• –û—Ç–≤–µ—Ç –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è', {
          status: response.status,
          statusText: response.statusText,
          ok: response.ok
        });

        if (response.ok || response.status === 201) {
          const result = await response.json();
          logDebug('SAVE', '‚úÖ –°–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–æ', result);
          hideModal();
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏—è –∏–∑ API
          await renderEvents();
          
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º lastClickedDate, —á—Ç–æ–±—ã —Å–ª–µ–¥—É—é—â–µ–µ –Ω–∞–∂–∞—Ç–∏–µ —Å–Ω–æ–≤–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–ª–æ —Å–æ–±—ã—Ç–∏—è
          lastClickedDate = null;
          
          showToast('–°–æ–±—ã—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!', 'success');
          console.log('‚úÖ Event created:', result);
        } else {
          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å–æ–≥–ª–∞—Å–Ω–æ FRONTEND_GUIDE.md
          let errorMessage = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è';
          const errorText = await response.text().catch(() => '');
          
          logDebug('SAVE', '‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è', {
            status: response.status,
            statusText: response.statusText,
            errorText: errorText.substring(0, 500),
            requestData: eventData,
            initDataPresent: !!telegramInitData
          });
          
          if (response.status === 401) {
            errorMessage = '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.';
            logDebug('AUTH', '‚ùå 401 Unauthorized –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è', {
              url: `${API_BASE_URL}/api/events`,
              initDataPresent: !!telegramInitData,
              initDataLength: telegramInitData?.length,
              initDataPreview: telegramInitData ? telegramInitData.substring(0, 200) : 'MISSING',
              responseText: errorText,
              currentUser: currentUser,
              eventData: eventData
            });
            console.error('üî¥ 401 Unauthorized –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è:', {
              url: `${API_BASE_URL}/api/events`,
              initData: telegramInitData ? telegramInitData.substring(0, 200) + '...' : 'MISSING',
              user: currentUser,
              eventData: eventData,
              response: errorText
            });
            if (tg) {
              tg.showAlert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.');
            }
          } else if (response.status === 403) {
            errorMessage = '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—è.';
            logDebug('AUTH', '‚ùå 403 Forbidden', {
              url: `${API_BASE_URL}/api/events`,
              responseText: errorText
            });
            if (tg) {
              tg.showAlert('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—è.');
            }
          } else if (response.status === 400) {
            try {
              const errorData = JSON.parse(errorText);
              errorMessage = errorData.message || '–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è';
            } catch {
              errorMessage = '–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ.';
            }
            if (tg) {
              tg.showAlert(`–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: ${errorMessage}`);
            }
          } else {
            errorMessage = `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`;
            if (tg) {
              tg.showAlert(`–û—à–∏–±–∫–∞: ${response.status}`);
            }
          }
          throw new Error(errorMessage);
        }
      } catch (error) {
        console.error('Error details:', {
          message: error.message,
          name: error.name,
          stack: error.stack,
          apiUrl: API_BASE_URL
        });
        
        let userMessage = error.message;
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫
        if (error.message.includes('Failed to fetch') || error.message.includes('load failed')) {
          userMessage = `–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n1. Backend –∑–∞–ø—É—â–µ–Ω –Ω–∞ ${API_BASE_URL}\n2. Cloudflare Tunnel –∞–∫—Ç–∏–≤–µ–Ω (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)\n3. –ù–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ CORS`;
        }
        
        showToast(userMessage, 'error');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º alert –≤ Telegram, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
        if (tg && tg.showAlert) {
          tg.showAlert(userMessage);
        }
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = originalText;
      }
    }

    function changeMonth(delta) {
      currentMonth += delta;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      } else if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –ø—Ä–∏ —Å–º–µ–Ω–µ –º–µ—Å—è—Ü–∞
      lastClickedDate = null;
      selectedDate = null;
      renderCalendar();
      // renderEvents –≤—ã–∑–æ–≤–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ renderCalendar
    }

    // –ü–æ—Å–ª–µ–¥–Ω—è—è –∫–ª–∏–∫–Ω—É—Ç–∞—è –¥–∞—Ç–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∫–ª–∏–∫–æ–≤
    let lastClickedDate = null;

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –¥–∞—Ç–µ
    function handleDateClick(date) {
      console.log('–ö–ª–∏–∫ –ø–æ –¥–∞—Ç–µ:', date, '–ü–æ—Å–ª–µ–¥–Ω—è—è:', lastClickedDate);
      
      // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –ø–æ —Ç–æ–π –∂–µ –¥–∞—Ç–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
      if (lastClickedDate === date) {
        console.log('–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∫–ª–∏–∫ - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É');
        showModal(date);
      } else {
        // –ü–µ—Ä–≤—ã–π –∫–ª–∏–∫ - –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è
        console.log('–ü–µ—Ä–≤—ã–π –∫–ª–∏–∫ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è');
        selectedDate = date;
        lastClickedDate = date;
        renderEvents();
      }
    }

    // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–ª–∏–∫–æ–≤ –ø–æ –¥–∞—Ç–∞–º (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –∫–ª–∏–∫–∏ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ)
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ tbody –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    document.getElementById('calendar-body').addEventListener('click', (e) => {
      // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–∏–π —ç–ª–µ–º–µ–Ω—Ç —Å data-date (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞ —Å–∞–º–æ–π —è—á–µ–π–∫–µ –∏–ª–∏ –≤–Ω—É—Ç—Ä–∏)
      const dayCell = e.target.closest('[data-date]');
      if (dayCell && dayCell.hasAttribute('data-date')) {
        e.preventDefault();
        e.stopPropagation();
        const clickedDate = dayCell.getAttribute('data-date');
        if (clickedDate) {
          handleDateClick(clickedDate);
        }
      }
    });

    // Event listeners
    document.getElementById('prev-month').addEventListener('click', () => changeMonth(-1));
    document.getElementById('next-month').addEventListener('click', () => changeMonth(1));
    
    // Modal handlers
    document.getElementById('close-modal').addEventListener('click', hideModal);
    document.getElementById('cancel-btn').addEventListener('click', hideModal);
    document.getElementById('save-btn').addEventListener('click', saveEvent);
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ—ë –æ–±–ª–∞—Å—Ç–∏
    document.getElementById('event-modal').addEventListener('click', (e) => {
      if (e.target.id === 'event-modal') {
        hideModal();
      }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø–æ Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        hideModal();
      }
    });

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ Enter (—Ç–æ–ª—å–∫–æ –≤ –ø–æ–ª–µ –Ω–∞–∑–≤–∞–Ω–∏—è, –Ω–µ –≤ textarea)
    document.getElementById('event-title').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        saveEvent();
      }
    });

    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)
    function displayUserInfo() {
      const userInfoEl = document.getElementById('user-info');
      if (currentUser && userInfoEl) {
        const userName = currentUser.username 
          ? `${currentUser.name} (@${currentUser.username})` 
          : currentUser.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        userInfoEl.textContent = userName;
        userInfoEl.classList.remove('hidden');
      }
    }

    // Initial render
    renderCalendar();
    displayUserInfo();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –¥–ª—è —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const today = new Date();
    selectedDate = formatDate(today.getFullYear(), today.getMonth(), today.getDate());
    renderEvents();
  </script>

</body>
</html>