<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–°–µ–º–µ–π–Ω—ã–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #calendar-select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
      padding-right: 2.5rem;
    }
    #calendar-select:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body class="bg-gray-900 text-white">
  <div class="flex items-center justify-center py-8 px-4">
    <div class="max-w-sm w-full shadow-lg">
      <div class="md:p-8 p-5 dark:bg-gray-800 bg-white rounded-t">
        <div class="px-4 mb-3">
          <select id="calendar-select" class="w-full px-3 py-2 bg-gray-700 dark:bg-gray-700 border border-gray-600 dark:border-gray-600 rounded-lg text-white dark:text-white text-sm font-medium focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent appearance-none cursor-pointer">
            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π...</option>
          </select>
        </div>
        <div class="px-4 flex items-center justify-between">
          <div>
            <span id="calendar-title" tabindex="0" class="focus:outline-none text-base font-bold dark:text-gray-100 text-gray-800">January 2025</span>
            <div id="user-info" class="hidden text-xs text-gray-400 dark:text-gray-400 mt-1"></div>
          </div>
          <div class="flex items-center">
            <button id="prev-month" aria-label="calendar backward" class="focus:text-gray-400 hover:text-gray-400 text-gray-800 dark:text-gray-100">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <polyline points="15 6 9 12 15 18" />
              </svg>
            </button>
            <button id="next-month" aria-label="calendar forward" class="focus:text-gray-400 hover:text-gray-400 ml-3 text-gray-800 dark:text-gray-100">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <polyline points="9 6 15 12 9 18" />
              </svg>
            </button>
          </div>
        </div>
        <div class="flex items-center justify-between pt-12 overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr>
                <th><div class="w-full flex justify-center"><p class="text-base font-medium text-center text-gray-800 dark:text-gray-100">Mo</p></div></th>
                <th><div class="w-full flex justify-center"><p class="text-base font-medium text-center text-gray-800 dark:text-gray-100">Tu</p></div></th>
                <th><div class="w-full flex justify-center"><p class="text-base font-medium text-center text-gray-800 dark:text-gray-100">We</p></div></th>
                <th><div class="w-full flex justify-center"><p class="text-base font-medium text-center text-gray-800 dark:text-gray-100">Th</p></div></th>
                <th><div class="w-full flex justify-center"><p class="text-base font-medium text-center text-gray-800 dark:text-gray-100">Fr</p></div></th>
                <th><div class="w-full flex justify-center"><p class="text-base font-medium text-center text-gray-800 dark:text-gray-100">Sa</p></div></th>
                <th><div class="w-full flex justify-center"><p class="text-base font-medium text-center text-gray-800 dark:text-gray-100">Su</p></div></th>
              </tr>
            </thead>
            <tbody id="calendar-body"></tbody>
          </table>
        </div>
      </div>
      <div class="md:py-8 py-5 md:px-16 px-5 dark:bg-gray-700 bg-gray-50 rounded-b">
        <div class="px-4" id="events-list">
          <p class="text-sm text-gray-500 dark:text-gray-300">–°–æ–±—ã—Ç–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è -->
  <div id="event-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-opacity">
    <div class="bg-gray-800 dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 transform transition-all">
      <div class="px-6 py-4 border-b border-gray-700">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-semibold text-white dark:text-white">–ù–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ</h3>
          <button id="close-modal" class="text-gray-400 hover:text-gray-200 transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>
      <div class="px-6 py-4">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-300 mb-2" for="event-date">–î–∞—Ç–∞</label>
          <input type="text" id="event-date" readonly class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-300 mb-2" for="event-time">–í—Ä–µ–º—è</label>
          <input type="time" id="event-time" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" value="09:00" />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-300 mb-2" for="event-title">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</label>
          <input type="text" id="event-title" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" autofocus />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-300 mb-2" for="event-duration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω—É—Ç—ã)</label>
          <input type="number" id="event-duration" min="15" step="15" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" value="60" placeholder="60" />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-300 mb-2" for="event-reminder">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <select id="event-reminder" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
            <option value="">–ë–µ–∑ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</option>
            <option value="15">–ó–∞ 15 –º–∏–Ω—É—Ç</option>
            <option value="30">–ó–∞ 30 –º–∏–Ω—É—Ç</option>
            <option value="60">–ó–∞ 1 —á–∞—Å</option>
            <option value="120">–ó–∞ 2 —á–∞—Å–∞</option>
            <option value="360">–ó–∞ 6 —á–∞—Å–æ–≤</option>
            <option value="720">–ó–∞ 12 —á–∞—Å–æ–≤</option>
          </select>
        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-300 mb-2" for="event-description">–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <textarea id="event-description" rows="3" placeholder="–î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none"></textarea>
        </div>
      </div>
      <div class="px-6 py-4 border-t border-gray-700 flex justify-end space-x-3">
        <button id="cancel-btn" class="px-4 py-2 text-gray-300 hover:text-white bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500">–û—Ç–º–µ–Ω–∞</button>
        <button id="save-btn" class="px-4 py-2 text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-800">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
  <div id="toast" class="hidden fixed top-4 right-4 bg-gray-800 border border-gray-700 rounded-lg shadow-lg px-6 py-4 z-50 transform transition-all">
    <div class="flex items-center space-x-3">
      <div id="toast-icon"></div>
      <p id="toast-message" class="text-white"></p>
    </div>
  </div>

  <script>
    // API endpoint
    function getApiBaseUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const apiUrl = urlParams.get('api_url');
      if (apiUrl) return apiUrl;
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        return 'http://localhost:8080';
      }
      return window.location.origin + '/family-calendar';
    }
    
    const API_BASE_URL = getApiBaseUrl();
    console.log('API Base URL:', API_BASE_URL);
    
    const DEBUG = true;
    
    function logDebug(category, message, data = null) {
      if (DEBUG) {
        const timestamp = new Date().toISOString();
        console.log(`[${timestamp}] [${category}]`, message, data || '');
      }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    const tg = window.Telegram?.WebApp;
    let currentUser = null;
    let telegramInitData = null;
    let availableCalendars = [];
    let currentCalendarId = null;
    let currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    let selectedDate = null;
    
    const monthNamesRu = [
      '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
      '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
    ];
    
    function formatDate(year, month, day) {
      const m = String(month + 1).padStart(2, '0');
      const d = String(day).padStart(2, '0');
      return `${year}-${m}-${d}`;
    }
    
    function formatDateDisplay(dateStr) {
      const [year, month, day] = dateStr.split('-');
      const date = new Date(year, month - 1, day);
      const dayNames = ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞'];
      const monthNames = ['—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è', 
                         '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'];
      return `${dayNames[date.getDay()]}, ${day} ${monthNames[date.getMonth()]} ${year}`;
    }
    
    function formatTime(time24) {
      const [hours, minutes] = time24.split(':');
      const h = parseInt(hours);
      const ampm = h >= 12 ? 'PM' : 'AM';
      const h12 = h % 12 || 12;
      return `${h12}:${minutes} ${ampm}`;
    }
    
    function showModal(date) {
      selectedDate = date;
      const modal = document.getElementById('event-modal');
      const dateInput = document.getElementById('event-date');
      const timeInput = document.getElementById('event-time');
      const titleInput = document.getElementById('event-title');
      const durationInput = document.getElementById('event-duration');
      const descriptionInput = document.getElementById('event-description');
      
      dateInput.value = formatDateDisplay(date);
      timeInput.value = '09:00';
      titleInput.value = '';
      durationInput.value = '60';
      descriptionInput.value = '';
      const reminderInput = document.getElementById('event-reminder');
      if (reminderInput) reminderInput.value = '';
      modal.classList.remove('hidden');
      setTimeout(() => titleInput.focus(), 100);
    }
    
    function combineDateTime(dateStr, timeStr) {
      const [year, month, day] = dateStr.split('-').map(Number);
      const [hours, minutes] = timeStr.split(':').map(Number);
      const localDate = new Date(year, month - 1, day, hours, minutes);
      return localDate.toISOString();
    }
    
    function hideModal() {
      const modal = document.getElementById('event-modal');
      modal.classList.add('hidden');
      if (selectedDate) {
        renderEvents();
      }
    }
    
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');
      const toastIcon = document.getElementById('toast-icon');
      
      toastMessage.textContent = message;
      
      if (type === 'success') {
        toastIcon.innerHTML = `
          <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        `;
      } else {
        toastIcon.innerHTML = `
          <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        `;
      }
      
      toast.classList.remove('hidden');
      setTimeout(() => {
        toast.classList.add('hidden');
      }, 3000);
    }
    
    function renderCalendar() {
      const titleElement = document.getElementById('calendar-title');
      titleElement.textContent = `${monthNamesRu[currentMonth]} ${currentYear}`;
      
      const calendarBody = document.getElementById('calendar-body');
      calendarBody.innerHTML = '';
      
      const firstDay = new Date(currentYear, currentMonth, 1);
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
      
      let date = 1;
      const weeksNeeded = Math.ceil((startingDayOfWeek + daysInMonth) / 7);
      
      for (let week = 0; week < weeksNeeded; week++) {
        const row = document.createElement('tr');
        
        for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
          const cell = document.createElement('td');
          if (week === 0 && dayOfWeek < startingDayOfWeek) {
            cell.className = 'pt-6';
            const div = document.createElement('div');
            div.className = 'px-2 py-2 cursor-pointer flex w-full justify-center';
            cell.appendChild(div);
          } else if (date > daysInMonth) {
            cell.className = week === 0 ? 'pt-6' : '';
            const div = document.createElement('div');
            div.className = 'px-2 py-2 cursor-pointer flex w-full justify-center';
            cell.appendChild(div);
          } else {
            const dayCell = document.createElement('div');
            dayCell.className = 'px-2 py-2 cursor-pointer flex w-full justify-center day-cell hover:bg-gray-700 rounded-lg transition-colors';
            dayCell.setAttribute('data-date', formatDate(currentYear, currentMonth, date));
            
            const today = new Date();
            const isToday = date === today.getDate() && 
                           currentMonth === today.getMonth() && 
                           currentYear === today.getFullYear();
            
            if (isToday) {
              dayCell.innerHTML = `
                <div class="w-full h-full">
                  <div class="flex items-center justify-center w-full rounded-full cursor-pointer">
                    <a role="link" tabindex="0" class="focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-700 focus:bg-indigo-500 hover:bg-indigo-500 text-base w-8 h-8 flex items-center justify-center font-medium text-white bg-indigo-700 rounded-full">${date}</a>
                  </div>
                </div>
              `;
            } else {
              const p = document.createElement('p');
              p.className = 'text-base text-gray-500 dark:text-gray-100 font-medium';
              p.textContent = date;
              dayCell.appendChild(p);
            }
            
            cell.appendChild(dayCell);
            date++;
          }
          row.appendChild(cell);
        }
        calendarBody.appendChild(row);
      }
    }
    
    async function loadCalendars() {
      if (!telegramInitData) {
        console.error('Telegram InitData –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
        return null;
      }
      
      const url = `${API_BASE_URL}/api/calendars`;
      console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π:', url);
      
      try {
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'X-Telegram-Init-Data': telegramInitData
          }
        });
        
        if (!response.ok) {
          const errorText = await response.text().catch(() => '');
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π:', response.status, errorText);
          if (response.status === 401) {
            if (tg) {
              tg.showAlert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.');
            }
          }
          return null;
        }
        
        const calendars = await response.json();
        console.log('–ö–∞–ª–µ–Ω–¥–∞—Ä–∏ –ø–æ–ª—É—á–µ–Ω—ã:', calendars);
        
        if (calendars && calendars.length > 0) {
          availableCalendars = calendars;
          
          const calendarSelect = document.getElementById('calendar-select');
          calendarSelect.innerHTML = '';
          calendars.forEach(cal => {
            const option = document.createElement('option');
            option.value = cal.id;
            option.textContent = cal.name || `–ö–∞–ª–µ–Ω–¥–∞—Ä—å #${cal.id}`;
            calendarSelect.appendChild(option);
          });
          
          currentCalendarId = calendars[0].id;
          calendarSelect.value = currentCalendarId;
          console.log('–¢–µ–∫—É—â–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', currentCalendarId, calendars[0].name);
          
          return calendars;
        } else {
          const calendarSelect = document.getElementById('calendar-select');
          calendarSelect.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π</option>';
          return [];
        }
      } catch (error) {
        console.error('–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π:', error);
        const calendarSelect = document.getElementById('calendar-select');
        calendarSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π</option>';
        return null;
      }
    }
    
    async function fetchEvents(calendarId, startFrom, startTo) {
      if (!telegramInitData) {
        console.error('Telegram initData –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
        return null;
      }
      
      if (!calendarId) {
        console.warn('calendarId –Ω–µ —É–∫–∞–∑–∞–Ω');
        return null;
      }
      
      try {
        let url = `${API_BASE_URL}/api/events/calendar/${calendarId}?page=0&size=100`;
        if (startFrom && startTo) {
          url += `&startFrom=${startFrom}&startTo=${startTo}`;
        }
        
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'X-Telegram-Init-Data': telegramInitData
          }
        });
        
        if (!response.ok) {
          const errorText = await response.text().catch(() => '');
          console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π:', response.status, errorText);
          return null;
        }
        
        const page = await response.json();
        return page.content || [];
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π:', error);
        return null;
      }
    }
    
    async function renderEvents() {
      const eventsList = document.getElementById('events-list');
      
      if (!currentCalendarId) {
        eventsList.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-300">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è...</p>';
        return;
      }
      
      eventsList.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-300">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π...</p>';
      
      const today = new Date();
      const todayStr = formatDate(today.getFullYear(), today.getMonth(), today.getDate());
      const targetDate = selectedDate || todayStr;
      
      const firstDay = new Date(currentYear, currentMonth, 1);
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      const startFrom = `${formatDate(currentYear, currentMonth, 1)}T00:00:00Z`;
      const startTo = `${formatDate(currentYear, currentMonth, lastDay.getDate())}T23:59:59Z`;
      
      const allEvents = await fetchEvents(currentCalendarId, startFrom, startTo);
      
      if (!allEvents || allEvents.length === 0) {
        eventsList.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-300">–°–æ–±—ã—Ç–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è</p>';
        return;
      }
      
      const selectedEvents = allEvents.filter(event => {
        if (!event.startAt) return false;
        const eventDate = new Date(event.startAt);
        const targetDateObj = new Date(targetDate + 'T00:00:00Z');
        return eventDate.toISOString().split('T')[0] === targetDateObj.toISOString().split('T')[0];
      });
      
      if (selectedEvents.length === 0) {
        eventsList.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-300">–ù–∞ —ç—Ç—É –¥–∞—Ç—É —Å–æ–±—ã—Ç–∏–π –Ω–µ—Ç</p>';
        return;
      }
      
      selectedEvents.sort((a, b) => {
        if (!a.startAt) return 1;
        if (!b.startAt) return -1;
        return new Date(a.startAt) - new Date(b.startAt);
      });
      
      const now = new Date();
      
      eventsList.innerHTML = selectedEvents.map((event, index) => {
        const startDate = new Date(event.startAt);
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –±—Ä–∞—É–∑–µ—Ä–∞, –∞ –Ω–µ UTC
        const timeStr = `${String(startDate.getHours()).padStart(2, '0')}:${String(startDate.getMinutes()).padStart(2, '0')}`;
        const timeDisplay = formatTime(timeStr);
        const description = event.description || '';
        const duration = event.durationMinutes ? `${Math.floor(event.durationMinutes / 60)}—á ${event.durationMinutes % 60}–º` : '';
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—à–ª–æ –ª–∏ —Å–æ–±—ã—Ç–∏–µ (—É—á–∏—Ç—ã–≤–∞–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
        const eventEndTime = new Date(startDate.getTime() + (event.durationMinutes || 0) * 60 * 1000);
        const isPast = eventEndTime < now;
        
        let reminderText = '';
        if (event.reminderMinutes) {
          const reminderMins = event.reminderMinutes;
          if (reminderMins >= 60) {
            const hours = Math.floor(reminderMins / 60);
            reminderText = `üîî –ó–∞ ${hours} —á`;
            if (reminderMins % 60 > 0) {
              reminderText += ` ${reminderMins % 60} –º`;
            }
          } else {
            reminderText = `üîî –ó–∞ ${reminderMins} –º`;
          }
        }
        
        return `
          <div class="border-b pb-4 border-gray-400 border-dashed ${index > 0 ? 'pt-5' : ''} ${isPast ? 'opacity-60' : ''}">
            <div class="flex items-center justify-between mb-1">
              <p class="text-xs font-light leading-3 text-gray-500 dark:text-gray-300">${timeDisplay}${duration ? ` ‚Ä¢ ${duration}` : ''}${reminderText ? ` ‚Ä¢ ${reminderText}` : ''}${isPast ? ' ‚Ä¢ ‚úÖ –ü—Ä–æ—à–ª–æ' : ''}</p>
            </div>
            <p class="text-base font-semibold pb-2 text-gray-800 dark:text-gray-100 ${isPast ? 'line-through' : ''}">${event.title}</p>
            ${description ? `<p class="text-sm text-gray-500 dark:text-gray-400 ${isPast ? 'line-through' : ''}">${description}</p>` : ''}
          </div>
        `;
      }).join('');
    }
    
    function changeMonth(delta) {
      currentMonth += delta;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      } else if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      selectedDate = null;
      renderCalendar();
      renderEvents();
    }
    
    let lastClickedDate = null;
    
    function handleDateClick(date) {
      if (lastClickedDate === date) {
        showModal(date);
      } else {
        selectedDate = date;
        lastClickedDate = date;
        renderEvents();
      }
    }
    
    document.getElementById('calendar-body').addEventListener('click', (e) => {
      const dayCell = e.target.closest('[data-date]');
      if (dayCell && dayCell.hasAttribute('data-date')) {
        e.preventDefault();
        e.stopPropagation();
        const clickedDate = dayCell.getAttribute('data-date');
        if (clickedDate) {
          handleDateClick(clickedDate);
        }
      }
    });
    
    document.getElementById('prev-month').addEventListener('click', () => changeMonth(-1));
    document.getElementById('next-month').addEventListener('click', () => changeMonth(1));
    document.getElementById('close-modal').addEventListener('click', hideModal);
    document.getElementById('cancel-btn').addEventListener('click', hideModal);
    
    document.getElementById('event-modal').addEventListener('click', (e) => {
      if (e.target.id === 'event-modal') {
        hideModal();
      }
    });
    
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        hideModal();
      }
    });
    
    document.getElementById('event-title').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        saveEvent();
      }
    });
    
    function displayUserInfo() {
      const userInfoEl = document.getElementById('user-info');
      if (currentUser && userInfoEl) {
        const userName = currentUser.username 
          ? `${currentUser.name} (@${currentUser.username})` 
          : currentUser.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        userInfoEl.textContent = userName;
        userInfoEl.classList.remove('hidden');
      }
    }
    
    async function saveEvent() {
      if (!currentCalendarId) {
        showToast('–ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–µ –≤—ã–±—Ä–∞–Ω', 'error');
        return;
      }
      
      const titleInput = document.getElementById('event-title');
      const timeInput = document.getElementById('event-time');
      const durationInput = document.getElementById('event-duration');
      const descriptionInput = document.getElementById('event-description');
      const reminderInput = document.getElementById('event-reminder');
      
      const title = titleInput.value.trim();
      const time = timeInput.value;
      const duration = parseInt(durationInput.value);
      const description = descriptionInput.value.trim();
      let reminderMinutes = null;
      if (reminderInput && reminderInput.value) {
        reminderMinutes = parseInt(reminderInput.value);
      }
      
      if (!title) {
        showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è', 'error');
        titleInput.focus();
        return;
      }
      
      if (!telegramInitData) {
        showToast('Telegram initData –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
        return;
      }
      
      const startAt = combineDateTime(selectedDate, time);
      
      const eventData = {
        calendarId: currentCalendarId,
        title: title,
        startAt: startAt,
        durationMinutes: duration,
        reminderMinutes: reminderMinutes,
        description: description || undefined
      };
      
      const saveBtn = document.getElementById('save-btn');
      const originalText = saveBtn.textContent;
      saveBtn.disabled = true;
      saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/events`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Telegram-Init-Data': telegramInitData
          },
          body: JSON.stringify(eventData)
        });
        
        if (!response.ok) {
          const errorText = await response.text().catch(() => '');
          let errorMessage = `–û—à–∏–±–∫–∞: ${response.status}`;
          
          if (response.status === 401) {
            errorMessage = '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.';
            if (tg) {
              tg.showAlert(errorMessage);
            }
          } else if (response.status === 400) {
            try {
              const errorData = JSON.parse(errorText);
              errorMessage = errorData.error || '–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ.';
            } catch {
              errorMessage = '–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ.';
            }
          }
          
          showToast(errorMessage, 'error');
          throw new Error(errorMessage);
        }
        
        const event = await response.json();
        showToast('–°–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–æ!', 'success');
        hideModal();
        renderEvents();
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è:', error);
        showToast(error.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è', 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = originalText;
      }
    }
    
    document.getElementById('save-btn').addEventListener('click', saveEvent);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π
    if (!tg?.initDataUnsafe?.user) {
      console.warn('Telegram user not found');
      alert("–û—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram");
    } else {
      tg.ready();
      tg.expand();
      
      const user = tg.initDataUnsafe.user;
      currentUser = {
        id: user.id,
        name: user.first_name,
        username: user.username || null,
      };
      
      telegramInitData = tg.initData;
      
      if (!telegramInitData) {
        console.warn('Telegram initData –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
      } else {
        console.log('Telegram initData –ø–æ–ª—É—á–µ–Ω');
      }
      
      displayUserInfo();
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä–∏ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      loadCalendars().then((calendars) => {
        if (!calendars || calendars.length === 0) {
          console.error('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π');
          showToast('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π', 'error');
          return;
        }
        
        console.log('–ö–∞–ª–µ–Ω–¥–∞—Ä–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –Ω–∞—á–∏–Ω–∞–µ–º –æ—Ç—Ä–∏—Å–æ–≤–∫—É...');
        renderCalendar();
        
        const today = new Date();
        selectedDate = formatDate(today.getFullYear(), today.getMonth(), today.getDate());
        renderEvents();
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        const calendarSelectEl = document.getElementById('calendar-select');
        if (calendarSelectEl) {
          calendarSelectEl.addEventListener('change', (e) => {
            const newCalendarId = parseInt(e.target.value);
            if (newCalendarId && newCalendarId !== currentCalendarId) {
              currentCalendarId = newCalendarId;
              console.log('–ö–∞–ª–µ–Ω–¥–∞—Ä—å –∏–∑–º–µ–Ω–µ–Ω:', currentCalendarId);
              renderEvents();
            }
          });
        }
      }).catch(err => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π:', err);
        showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä–∏', 'error');
      });
    }
  </script>
</body>
</html>

